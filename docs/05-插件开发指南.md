# VoxNest 插件开发指南

## 快速开始

### 环境准备
- .NET 9.0 SDK
- Visual Studio 2022 或 VS Code
- VoxNest Plugin SDK

### 创建插件项目
```bash
# 安装插件模板
dotnet new install VoxNest.Plugin.Templates

# 创建新插件
dotnet new voxnest-plugin -n MyBlogPlugin -o ./MyBlogPlugin

# 进入项目目录
cd MyBlogPlugin
```

### 项目结构
```
MyBlogPlugin/
├── MyBlogPlugin.csproj          # 项目文件
├── Plugin.cs                    # 插件主类
├── plugin.json                  # 插件元数据
├── Controllers/                 # API控制器
│   └── BlogController.cs
├── Services/                    # 业务服务
│   └── BlogService.cs
├── Models/                      # 数据模型
│   └── BlogPost.cs
├── Views/                       # 视图模板
├── wwwroot/                     # 静态资源
│   ├── js/
│   ├── css/
│   └── images/
└── README.md                    # 插件说明
```

## 插件基础开发

### 插件主类实现
```csharp
using VoxNest.Core.Plugins;
using Microsoft.Extensions.DependencyInjection;

[Plugin("blog-plugin", "1.0.0")]
public class BlogPlugin : IPlugin, IContentPlugin, IUIPlugin
{
    public string Id => "blog-plugin";
    public string Name => "博客插件";
    public string Version => "1.0.0";
    public string Description => "提供博客文章发布和管理功能";
    public string Author => "VoxNest Team";

    private IPluginContext _context;

    public async Task<bool> InitializeAsync(IPluginContext context)
    {
        _context = context;
        
        // 注册服务
        context.Services.AddScoped<IBlogService, BlogService>();
        context.Services.AddScoped<BlogController>();
        
        // 订阅事件
        context.EventBus.Subscribe<UserRegisteredEvent>(OnUserRegistered);
        
        return true;
    }

    public async Task<bool> StartAsync()
    {
        _context.Logger.LogInformation("博客插件已启动");
        return true;
    }

    public async Task<bool> StopAsync()
    {
        _context.Logger.LogInformation("博客插件已停止");
        return true;
    }

    public async Task<bool> UnloadAsync()
    {
        // 清理资源
        return true;
    }

    private async Task OnUserRegistered(UserRegisteredEvent eventData)
    {
        // 为新用户创建默认博客设置
        var blogService = _context.GetService<IBlogService>();
        await blogService.CreateDefaultSettingsAsync(eventData.UserId);
    }
}
```

### 插件元数据配置
```json
{
  "id": "blog-plugin",
  "name": "博客插件",
  "version": "1.0.0",
  "description": "提供博客文章发布和管理功能",
  "author": "VoxNest Team",
  "homepage": "https://github.com/voxnest/blog-plugin",
  "license": "MIT",
  "keywords": ["blog", "content", "writing"],
  
  "dependencies": {
    "voxnest-core": ">=1.0.0",
    "content-plugin": ">=1.0.0"
  },
  
  "permissions": [
    "content.create",
    "content.edit",
    "content.delete",
    "file.upload"
  ],
  
  "configuration": {
    "maxPostLength": {
      "type": "integer",
      "default": 50000,
      "description": "文章最大长度"
    },
    "allowComments": {
      "type": "boolean",
      "default": true,
      "description": "是否允许评论"
    }
  },
  
  "routes": [
    {
      "path": "/blog",
      "component": "BlogList"
    },
    {
      "path": "/blog/post/:id",
      "component": "BlogPost"
    },
    {
      "path": "/blog/create",
      "component": "CreatePost",
      "requireAuth": true
    }
  ],
  
  "menus": [
    {
      "title": "博客",
      "icon": "blog",
      "path": "/blog",
      "order": 10
    }
  ]
}
```

## 内容插件开发

### 实现内容插件接口
```csharp
public class BlogPlugin : IContentPlugin
{
    public string ContentType => "blog-post";

    public async Task<ContentResult> CreateContentAsync(CreateContentRequest request)
    {
        var blogPost = new BlogPost
        {
            Title = request.Title,
            Content = request.Body,
            AuthorId = request.AuthorId,
            Tags = request.Metadata.GetValueOrDefault("tags", "").Split(','),
            Category = request.Metadata.GetValueOrDefault("category", ""),
            CreatedAt = DateTime.UtcNow
        };

        var blogService = _context.GetService<IBlogService>();
        var result = await blogService.CreatePostAsync(blogPost);

        return new ContentResult
        {
            Success = result.Success,
            ContentId = result.PostId,
            Message = result.Message
        };
    }

    public async Task<ContentResult> UpdateContentAsync(UpdateContentRequest request)
    {
        var blogService = _context.GetService<IBlogService>();
        var result = await blogService.UpdatePostAsync(request.ContentId, request);

        return new ContentResult
        {
            Success = result.Success,
            Message = result.Message
        };
    }

    public async Task<ContentListResult> GetContentListAsync(GetContentListRequest request)
    {
        var blogService = _context.GetService<IBlogService>();
        var posts = await blogService.GetPostsAsync(request.Page, request.PageSize, request.Filters);

        return new ContentListResult
        {
            Items = posts.Items.Select(p => new ContentItem
            {
                Id = p.Id,
                Title = p.Title,
                Summary = p.Summary,
                AuthorId = p.AuthorId,
                CreatedAt = p.CreatedAt
            }).ToList(),
            TotalCount = posts.TotalCount,
            Page = request.Page,
            PageSize = request.PageSize
        };
    }
}
```

## UI插件开发

### 前端组件开发
```typescript
// src/components/BlogList.tsx
import React, { useEffect, useState } from 'react';
import { Card, List, Tag, Button } from 'antd';
import { usePluginContext } from '@voxnest/plugin-sdk';

interface BlogPost {
  id: number;
  title: string;
  summary: string;
  author: string;
  createdAt: string;
  tags: string[];
}

export const BlogList: React.FC = () => {
  const [posts, setPosts] = useState<BlogPost[]>([]);
  const [loading, setLoading] = useState(true);
  const { apiClient, navigate } = usePluginContext();

  useEffect(() => {
    loadPosts();
  }, []);

  const loadPosts = async () => {
    try {
      const response = await apiClient.get('/api/blog/posts');
      setPosts(response.data.items);
    } catch (error) {
      console.error('加载博客文章失败:', error);
    } finally {
      setLoading(false);
    }
  };

  const handleCreatePost = () => {
    navigate('/blog/create');
  };

  return (
    <div className="blog-list">
      <div className="blog-header">
        <h1>博客文章</h1>
        <Button type="primary" onClick={handleCreatePost}>
          写文章
        </Button>
      </div>
      
      <List
        loading={loading}
        dataSource={posts}
        renderItem={(post) => (
          <List.Item>
            <Card
              title={post.title}
              extra={<span>{post.createdAt}</span>}
              onClick={() => navigate(`/blog/post/${post.id}`)}
            >
              <p>{post.summary}</p>
              <div className="post-meta">
                <span>作者: {post.author}</span>
                <div className="tags">
                  {post.tags.map(tag => (
                    <Tag key={tag}>{tag}</Tag>
                  ))}
                </div>
              </div>
            </Card>
          </List.Item>
        )}
      />
    </div>
  );
};
```

### 插件路由注册
```typescript
// src/index.ts
import { PluginModule } from '@voxnest/plugin-sdk';
import { BlogList } from './components/BlogList';
import { BlogPost } from './components/BlogPost';
import { CreatePost } from './components/CreatePost';

const plugin: PluginModule = {
  id: 'blog-plugin',
  name: '博客插件',
  version: '1.0.0',
  
  routes: [
    {
      path: '/blog',
      component: BlogList,
      exact: true
    },
    {
      path: '/blog/post/:id',
      component: BlogPost
    },
    {
      path: '/blog/create',
      component: CreatePost,
      requireAuth: true
    }
  ],
  
  menus: [
    {
      key: 'blog',
      title: '博客',
      icon: 'edit',
      path: '/blog',
      order: 10
    }
  ],
  
  async initialize(context) {
    // 插件初始化逻辑
    console.log('博客插件已初始化');
  }
};

export default plugin;
```

## 数据库集成

### Entity Framework集成
```csharp
public class BlogDbContext : DbContext
{
    public DbSet<BlogPost> BlogPosts { get; set; }
    public DbSet<BlogCategory> BlogCategories { get; set; }
    public DbSet<BlogComment> BlogComments { get; set; }

    protected override void OnModelCreating(ModelBuilder modelBuilder)
    {
        modelBuilder.Entity<BlogPost>(entity =>
        {
            entity.HasKey(e => e.Id);
            entity.Property(e => e.Title).HasMaxLength(500).IsRequired();
            entity.Property(e => e.Content).IsRequired();
            entity.Property(e => e.Summary).HasMaxLength(1000);
            
            entity.HasOne(e => e.Author)
                  .WithMany()
                  .HasForeignKey(e => e.AuthorId);
                  
            entity.HasOne(e => e.Category)
                  .WithMany(c => c.Posts)
                  .HasForeignKey(e => e.CategoryId);
        });
    }
}

// 在插件初始化时注册DbContext
public async Task<bool> InitializeAsync(IPluginContext context)
{
    context.Services.AddDbContext<BlogDbContext>(options =>
        options.UseNpgsql(context.Configuration.GetConnectionString("DefaultConnection")));
    
    // 自动迁移数据库
    using var scope = context.Services.CreateScope();
    var dbContext = scope.ServiceProvider.GetRequiredService<BlogDbContext>();
    await dbContext.Database.MigrateAsync();
    
    return true;
}
```

## 事件处理

### 发布事件
```csharp
public class BlogService : IBlogService
{
    private readonly IEventBus _eventBus;
    
    public async Task<CreatePostResult> CreatePostAsync(BlogPost post)
    {
        // 保存博客文章
        await _repository.AddAsync(post);
        
        // 发布事件
        await _eventBus.PublishAsync(new BlogPostCreatedEvent
        {
            PostId = post.Id,
            Title = post.Title,
            AuthorId = post.AuthorId,
            CreatedAt = post.CreatedAt
        });
        
        return new CreatePostResult { Success = true, PostId = post.Id };
    }
}
```

### 订阅事件
```csharp
public class BlogPlugin : IPlugin
{
    public async Task<bool> InitializeAsync(IPluginContext context)
    {
        // 订阅用户注册事件
        context.EventBus.Subscribe<UserRegisteredEvent>(async (eventData) =>
        {
            // 为新用户创建默认博客设置
            var blogService = context.GetService<IBlogService>();
            await blogService.CreateDefaultSettingsAsync(eventData.UserId);
        });
        
        // 订阅内容删除事件
        context.EventBus.Subscribe<ContentDeletedEvent>(async (eventData) =>
        {
            if (eventData.ContentType == "blog-post")
            {
                // 清理相关数据
                await CleanupBlogData(eventData.ContentId);
            }
        });
        
        return true;
    }
}
```

## 配置管理

### 插件配置
```csharp
public class BlogSettings
{
    public int MaxPostLength { get; set; } = 50000;
    public bool AllowComments { get; set; } = true;
    public bool ModerationEnabled { get; set; } = false;
    public string[] AllowedFileTypes { get; set; } = { "jpg", "png", "gif" };
}

public class BlogService : IBlogService
{
    private readonly BlogSettings _settings;
    
    public BlogService(IPluginConfiguration config)
    {
        _settings = config.GetSettings<BlogSettings>("blog-plugin");
    }
    
    public async Task<bool> ValidatePostAsync(BlogPost post)
    {
        if (post.Content.Length > _settings.MaxPostLength)
        {
            throw new ValidationException($"文章长度不能超过 {_settings.MaxPostLength} 字符");
        }
        
        return true;
    }
}
```

## 权限控制

### 权限检查
```csharp
[ApiController]
[Route("api/blog")]
public class BlogController : ControllerBase
{
    [HttpPost("posts")]
    [RequirePermission("blog.create")]
    public async Task<IActionResult> CreatePost([FromBody] CreatePostRequest request)
    {
        var blogService = HttpContext.RequestServices.GetRequiredService<IBlogService>();
        var result = await blogService.CreatePostAsync(request);
        return Ok(result);
    }
    
    [HttpPut("posts/{id}")]
    [RequirePermission("blog.edit")]
    public async Task<IActionResult> UpdatePost(int id, [FromBody] UpdatePostRequest request)
    {
        // 检查是否为文章作者或管理员
        if (!await IsAuthorOrAdmin(id))
        {
            return Forbid();
        }
        
        var blogService = HttpContext.RequestServices.GetRequiredService<IBlogService>();
        var result = await blogService.UpdatePostAsync(id, request);
        return Ok(result);
    }
}
```

## 测试

### 单元测试
```csharp
[TestClass]
public class BlogServiceTests
{
    private Mock<IBlogRepository> _mockRepository;
    private Mock<IEventBus> _mockEventBus;
    private BlogService _blogService;
    
    [TestInitialize]
    public void Setup()
    {
        _mockRepository = new Mock<IBlogRepository>();
        _mockEventBus = new Mock<IEventBus>();
        _blogService = new BlogService(_mockRepository.Object, _mockEventBus.Object);
    }
    
    [TestMethod]
    public async Task CreatePostAsync_ValidPost_ReturnsSuccess()
    {
        // Arrange
        var post = new BlogPost
        {
            Title = "测试文章",
            Content = "这是一篇测试文章",
            AuthorId = 1
        };
        
        _mockRepository.Setup(r => r.AddAsync(It.IsAny<BlogPost>()))
                      .Returns(Task.CompletedTask);
        
        // Act
        var result = await _blogService.CreatePostAsync(post);
        
        // Assert
        Assert.IsTrue(result.Success);
        _mockEventBus.Verify(e => e.PublishAsync(It.IsAny<BlogPostCreatedEvent>()), Times.Once);
    }
}
```

## 打包和发布

### 构建插件
```bash
# 构建插件
dotnet build --configuration Release

# 打包插件
dotnet pack --configuration Release --output ./packages
```

### 插件包结构
```
MyBlogPlugin.1.0.0.nupkg
├── lib/
│   └── net8.0/
│       ├── MyBlogPlugin.dll
│       └── MyBlogPlugin.pdb
├── content/
│   └── wwwroot/
│       ├── js/
│       ├── css/
│       └── images/
├── plugin.json
└── README.md
```

## 最佳实践

### 性能优化
- 使用异步方法处理IO操作
- 实现适当的缓存策略
- 避免在主线程执行耗时操作
- 使用分页查询大量数据

### 安全考虑
- 验证所有用户输入
- 使用参数化查询防止SQL注入
- 实现适当的权限检查
- 敏感数据加密存储

### 错误处理
- 使用结构化异常处理
- 记录详细的错误日志
- 提供友好的错误消息
- 实现优雅降级

### 代码质量
- 遵循SOLID原则
- 编写单元测试
- 使用依赖注入
- 保持代码简洁可读