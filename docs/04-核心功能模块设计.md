# VoxNest 核心功能模块设计

## 模块概览

VoxNest核心框架采用最小化设计原则，只包含系统运行的基础功能，所有业务功能通过插件实现。

```
Core Framework
├── Authentication & Authorization (认证授权)
├── User Management (用户管理)
├── Content Management (内容管理)
├── Extension Management (扩展管理) ⭐ 新增
├── Configuration Management (配置管理) ⭐ 新增
├── Timezone & Localization (时区与本地化) ⭐ 新增
├── System Configuration (系统配置)
├── API Gateway (API网关)
└── Event System (事件系统)
```

## 认证授权模块

### 功能范围
- 用户注册、登录、注销
- JWT Token管理
- 基础角色权限控制
- 第三方登录（插件实现）
- TOTP 二步验证（插件实现）

### 数据模型
```csharp
public class User
{
    public int Id { get; set; }
    public string Username { get; set; }
    public string Email { get; set; }
    public string PasswordHash { get; set; }
    public DateTime CreatedAt { get; set; }
    public DateTime? LastLoginAt { get; set; }
    public bool IsActive { get; set; }
    public ICollection<UserRole> UserRoles { get; set; }
}

public class Role
{
    public int Id { get; set; }
    public string Name { get; set; }
    public string Description { get; set; }
    public ICollection<RolePermission> RolePermissions { get; set; }
}

public class Permission
{
    public int Id { get; set; }
    public string Name { get; set; }
    public string Resource { get; set; }
    public string Action { get; set; }
}
```

### API接口
```csharp
[ApiController]
[Route("api/[controller]")]
public class AuthController : ControllerBase
{
    [HttpPost("register")]
    public async Task<IActionResult> Register(RegisterRequest request);
    
    [HttpPost("login")]
    public async Task<IActionResult> Login(LoginRequest request);
    
    [HttpPost("logout")]
    [Authorize]
    public async Task<IActionResult> Logout();
    
    [HttpPost("refresh")]
    public async Task<IActionResult> RefreshToken(RefreshTokenRequest request);
}
```

## 用户管理模块

### 功能范围
- 用户基础信息管理
- 用户配置文件
- 用户状态管理
- 用户关系管理接口

### 数据模型
```csharp
public class UserProfile
{
    public int UserId { get; set; }
    public string DisplayName { get; set; }
    public string Avatar { get; set; }
    public string Bio { get; set; }
    public string Location { get; set; }
    public string Website { get; set; }
    public DateTime? Birthday { get; set; }
    public string Gender { get; set; }
    public User User { get; set; }
}

public class UserSetting
{
    public int Id { get; set; }
    public int UserId { get; set; }
    public string Key { get; set; }
    public string Value { get; set; }
    public string Type { get; set; }
    public User User { get; set; }
}
```

## 内容管理模块

### 功能范围
- 通用内容CRUD操作
- 内容分类和标签
- 内容状态管理
- 内容权限控制

### 数据模型
```csharp
public class Content
{
    public int Id { get; set; }
    public string Title { get; set; }
    public string Body { get; set; }
    public string ContentType { get; set; }
    public ContentStatus Status { get; set; }
    public int AuthorId { get; set; }
    public DateTime CreatedAt { get; set; }
    public DateTime UpdatedAt { get; set; }
    public DateTime? PublishedAt { get; set; }
    
    public User Author { get; set; }
    public ICollection<ContentTag> ContentTags { get; set; }
    public ICollection<ContentCategory> ContentCategories { get; set; }
}

public enum ContentStatus
{
    Draft = 0,
    Published = 1,
    Archived = 2,
    Deleted = 3
}

public class Category
{
    public int Id { get; set; }
    public string Name { get; set; }
    public string Slug { get; set; }
    public string Description { get; set; }
    public int? ParentId { get; set; }
    public Category Parent { get; set; }
    public ICollection<Category> Children { get; set; }
}

public class Tag
{
    public int Id { get; set; }
    public string Name { get; set; }
    public string Slug { get; set; }
    public string Color { get; set; }
}
```

## 插件管理模块

### 功能范围
- 插件发现和加载
- 插件生命周期管理
- 插件配置管理
- 插件权限控制

### 数据模型
```csharp
public class Plugin
{
    public string Id { get; set; }
    public string Name { get; set; }
    public string Version { get; set; }
    public string Description { get; set; }
    public string Author { get; set; }
    public string AssemblyPath { get; set; }
    public bool IsEnabled { get; set; }
    public DateTime InstalledAt { get; set; }
    public DateTime? UpdatedAt { get; set; }
    public string Configuration { get; set; }
}

public class PluginDependency
{
    public string PluginId { get; set; }
    public string DependencyId { get; set; }
    public string MinVersion { get; set; }
    public string MaxVersion { get; set; }
}
```

### 管理接口
```csharp
public interface IPluginManager
{
    Task<IEnumerable<PluginInfo>> GetInstalledPluginsAsync();
    Task<bool> InstallPluginAsync(string packagePath);
    Task<bool> UninstallPluginAsync(string pluginId);
    Task<bool> EnablePluginAsync(string pluginId);
    Task<bool> DisablePluginAsync(string pluginId);
    Task<bool> UpdatePluginAsync(string pluginId, string packagePath);
}
```

## 系统配置模块

### 功能范围
- 系统全局配置
- 插件配置管理
- 配置热更新
- 配置备份恢复

### 数据模型
```csharp
public class SystemSetting
{
    public int Id { get; set; }
    public string Key { get; set; }
    public string Value { get; set; }
    public string Type { get; set; }
    public string Category { get; set; }
    public string Description { get; set; }
    public bool IsReadOnly { get; set; }
}

public class PluginSetting
{
    public int Id { get; set; }
    public string PluginId { get; set; }
    public string Key { get; set; }
    public string Value { get; set; }
    public string Type { get; set; }
}
```

## API网关模块

### 功能范围
- 统一API入口
- 请求路由和转发
- 认证和授权检查
- 限流和熔断

### 中间件设计
```csharp
public class ApiGatewayMiddleware
{
    private readonly RequestDelegate _next;
    
    public async Task InvokeAsync(HttpContext context)
    {
        // 1. 请求预处理
        await PreProcessRequest(context);
        
        // 2. 认证检查
        if (!await AuthenticateRequest(context))
        {
            context.Response.StatusCode = 401;
            return;
        }
        
        // 3. 授权检查
        if (!await AuthorizeRequest(context))
        {
            context.Response.StatusCode = 403;
            return;
        }
        
        // 4. 限流检查
        if (!await CheckRateLimit(context))
        {
            context.Response.StatusCode = 429;
            return;
        }
        
        // 5. 转发请求
        await _next(context);
        
        // 6. 响应后处理
        await PostProcessResponse(context);
    }
}
```

## 事件系统模块

### 功能范围
- 系统事件发布订阅
- 插件间通信
- 异步事件处理
- 事件持久化

### 事件定义
```csharp
public abstract class DomainEvent
{
    public Guid Id { get; } = Guid.NewGuid();
    public DateTime OccurredAt { get; } = DateTime.UtcNow;
    public string EventType => GetType().Name;
}

public class UserRegisteredEvent : DomainEvent
{
    public int UserId { get; set; }
    public string Username { get; set; }
    public string Email { get; set; }
}

public class ContentCreatedEvent : DomainEvent
{
    public int ContentId { get; set; }
    public string ContentType { get; set; }
    public int AuthorId { get; set; }
}
```

### 事件处理器
```csharp
public interface IEventHandler<T> where T : DomainEvent
{
    Task HandleAsync(T domainEvent);
}

public class UserRegisteredEventHandler : IEventHandler<UserRegisteredEvent>
{
    public async Task HandleAsync(UserRegisteredEvent domainEvent)
    {
        // 发送欢迎邮件
        // 创建默认用户配置
        // 记录用户注册日志
    }
}
```

## 数据库设计

### 核心表结构
```sql
-- 用户表
CREATE TABLE Users (
    Id SERIAL PRIMARY KEY,
    Username VARCHAR(50) UNIQUE NOT NULL,
    Email VARCHAR(255) UNIQUE NOT NULL,
    PasswordHash VARCHAR(255) NOT NULL,
    CreatedAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    LastLoginAt TIMESTAMP,
    IsActive BOOLEAN DEFAULT TRUE
);

-- 角色表
CREATE TABLE Roles (
    Id SERIAL PRIMARY KEY,
    Name VARCHAR(50) UNIQUE NOT NULL,
    Description TEXT
);

-- 权限表
CREATE TABLE Permissions (
    Id SERIAL PRIMARY KEY,
    Name VARCHAR(100) UNIQUE NOT NULL,
    Resource VARCHAR(50) NOT NULL,
    Action VARCHAR(50) NOT NULL
);

-- 内容表
CREATE TABLE Contents (
    Id SERIAL PRIMARY KEY,
    Title VARCHAR(500) NOT NULL,
    Body TEXT,
    ContentType VARCHAR(50) NOT NULL,
    Status INTEGER DEFAULT 0,
    AuthorId INTEGER REFERENCES Users(Id),
    CreatedAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UpdatedAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    PublishedAt TIMESTAMP
);

-- 插件表
CREATE TABLE Plugins (
    Id VARCHAR(100) PRIMARY KEY,
    Name VARCHAR(200) NOT NULL,
    Version VARCHAR(20) NOT NULL,
    Description TEXT,
    Author VARCHAR(100),
    AssemblyPath VARCHAR(500),
    IsEnabled BOOLEAN DEFAULT FALSE,
    InstalledAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UpdatedAt TIMESTAMP,
    Configuration JSONB
);
```

## 性能考虑

### 缓存策略
- **用户会话**: Redis缓存用户登录状态（插件实现）
- **权限信息**: 内存缓存用户权限数据
- **系统配置**: 内存缓存系统设置
- **插件元数据**: 内存缓存插件信息

### 数据库优化
- 为常用查询字段添加索引
- 使用数据库连接池
- 实现读写分离
- 定期清理过期数据

### API优化
- 实现API响应缓存
- 使用分页查询
- 实现字段选择查询
- 添加请求压缩

---

## 扩展管理模块 ⭐ 新增

### 功能范围
- 扩展（插件/主题）的启用/禁用管理
- 实时状态反馈和操作确认
- 扩展重新加载和卸载
- 扩展元数据管理
- 热重载系统优化

### 核心特性
- **实时状态更新**: 操作立即反馈，避免用户重复点击
- **防抖机制**: 优化热重载系统，避免频繁重载
- **状态管理**: 跟踪扩展的loading、active、inactive状态
- **错误处理**: 操作失败时恢复原状态，提供明确错误信息

### API接口
```csharp
[ApiController]
[Route("api/[controller]")]
public class FileSystemExtensionController : ControllerBase
{
    [HttpPost("{extensionId}/enable")]
    public async Task<Result> EnableExtension(string extensionId);
    
    [HttpPost("{extensionId}/disable")]
    public async Task<Result> DisableExtension(string extensionId);
    
    [HttpPost("{extensionId}/reload")]
    public async Task<Result> ReloadExtension(string extensionId);
    
    [HttpDelete("{extensionId}")]
    public async Task<Result> UninstallExtension(string extensionId);
    
    [HttpGet]
    public async Task<Result<IEnumerable<Extension>>> GetExtensions();
}
```

### 前端状态管理
```typescript
// 扩展状态类型
type ExtensionStatus = 'active' | 'inactive' | 'loading' | 'error';

// 状态管理逻辑
const handleToggleExtension = useCallback(async (extension: Extension) => {
  try {
    // 立即更新为loading状态，提供即时视觉反馈
    setExtensions(prev => prev.map(ext => 
      ext.uniqueId === extension.uniqueId 
        ? { ...ext, status: 'loading' }
        : ext
    ));
    
    // 执行API操作
    const result = isCurrentlyActive 
      ? await api.disableExtension(extension.uniqueId)
      : await api.enableExtension(extension.uniqueId);
      
    if (result.isSuccess) {
      // 重新加载获取最新状态
      await loadExtensions();
    } else {
      // 操作失败时恢复原状态
      setExtensions(prev => prev.map(ext => 
        ext.uniqueId === extension.uniqueId 
          ? { ...ext, status: extension.status }
          : ext
      ));
    }
  } catch (error) {
    // 异常处理和状态恢复
  }
}, [loadExtensions]);
```

## 配置管理模块 ⭐ 新增

### 功能范围
- 前后端配置统一管理
- 实时配置更新和验证
- 配置备份和恢复
- 多环境配置支持

### 核心特性
- **统一界面**: 前端和后端配置集中到单一管理页面
- **实时更新**: 配置修改后立即生效，无需重启
- **类型安全**: 完整的TypeScript类型定义和验证
- **YAML配置**: 基于YAML的配置文件，支持注释和版本控制

### 配置分类
```typescript
interface ServerConfig {
  server: {
    name: string;
    description: string;
    timeZone: string; // 新增时区设置
    enableHttpsRedirection: boolean;
    enableDetailedErrors: boolean;
    maxRequestBodySize: number;
  };
  database: {
    maxPoolSize: number;
    connectionTimeout: number;
  };
  cors: {
    allowedOrigins: string[];
    allowCredentials: boolean; // 新增
  };
  logging: {
    level: string;
    maxFileSize: string; // 新增
    retainedFileCount: number; // 新增
  };
}
```

### API接口
```csharp
[ApiController]
[Route("api/[controller]")]
public class ServerConfigController : ControllerBase
{
    [HttpGet]
    public async Task<Result<object>> GetFullConfig();
    
    [HttpGet("server")]
    public async Task<Result<ServerConfigDto>> GetServerConfig();
    
    [HttpPut("server")]
    public async Task<Result> UpdateServerConfig(ServerConfigDto config);
    
    [HttpGet("database")]
    public async Task<Result<DatabaseConfigDto>> GetDatabaseConfig();
    
    [HttpGet("timezones")]
    public async Task<Result<IEnumerable<TimeZoneInfo>>> GetAvailableTimeZones();
    
    [HttpPost("timezone")]
    public async Task<Result> SetTimeZone(SetTimeZoneRequest request);
    
    [HttpPost("backup")]
    public async Task<Result> BackupConfig();
    
    [HttpPost("reset")]
    public async Task<Result> ResetConfig();
}
```

## 时区与本地化模块 ⭐ 新增

### 功能范围
- 全球时区支持和配置
- 安装过程中的时区设置
- 时区数据的获取和管理
- 多语言扩展框架准备

### 时区功能
```csharp
public class TimeZoneService
{
    // 获取所有可用时区
    public async Task<IEnumerable<TimeZoneInfo>> GetAvailableTimeZonesAsync()
    {
        return TimeZoneInfo.GetSystemTimeZones()
            .Select(tz => new TimeZoneInfo
            {
                Id = tz.Id,
                DisplayName = tz.DisplayName,
                StandardName = tz.StandardName,
                BaseUtcOffset = tz.BaseUtcOffset.ToString()
            })
            .OrderBy(tz => tz.BaseUtcOffset)
            .ThenBy(tz => tz.DisplayName);
    }
    
    // 设置系统时区
    public async Task<bool> SetTimeZoneAsync(string timeZoneId)
    {
        // 更新server-config.yml中的时区设置
        // 验证时区ID有效性
        // 应用时区配置
    }
}
```

### 安装集成
```typescript
// 安装过程第四步：站点配置
interface SiteConfigStep {
  siteName: string;
  siteDescription: string;
  adminEmail: string;
  timeZone: string; // 新增时区选择
}

// 时区选择组件
<Form.Item label="站点时区" name="timeZone" rules={[{ required: true }]}>
  <Select
    placeholder="选择时区"
    loading={timeZoneLoading}
    showSearch
    filterOption={(input, option) => 
      option?.label?.toLowerCase().includes(input.toLowerCase())
    }
  >
    {availableTimeZones.map(tz => (
      <Option key={tz.id} value={tz.id} label={tz.displayName}>
        ({tz.baseUtcOffset}) {tz.displayName}
      </Option>
    ))}
  </Select>
</Form.Item>
```

### 配置存储
```yaml
# server-config.yml
server:
  name: "VoxNest"
  description: "VoxNest Community Site"
  time_zone: "Asia/Shanghai"  # 支持时区设置
  enable_https_redirection: true
  enable_detailed_errors: false
  max_request_body_size: 104857600

database:
  max_pool_size: 100
  connection_timeout: 30

cors:
  allowed_origins:
    - "http://localhost:3000"
    - "https://yourdomain.com"
  allow_credentials: true  # 新增配置

logging:
  level: "Information"
  max_file_size: "100MB"      # 新增配置
  retained_file_count: 31     # 新增配置
```

## 性能优化更新

### 热重载系统优化
- **防抖机制**: 1-2秒防抖延迟，避免频繁重载
- **轮询频率**: 从1秒增加到3-5秒，降低系统负担
- **状态跟踪**: 精确跟踪文件修改时间，避免虚假触发
- **定时器管理**: 完善的定时器清理机制，防止内存泄漏

### 扩展管理优化
- **useCallback优化**: 避免不必要的函数重新创建
- **状态批量更新**: 减少组件重渲染次数
- **错误边界**: 完善的错误处理和状态恢复
- **用户体验**: 立即的视觉反馈和状态指示