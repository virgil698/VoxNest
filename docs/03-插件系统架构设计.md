# VoxNest 插件系统架构设计

## 设计目标

### 核心目标
- **模块化**: 功能完全解耦，独立开发和部署
- **热插拔**: 运行时动态加载和卸载插件
- **标准化**: 统一的插件开发接口和规范
- **性能**: 最小化插件对系统性能的影响
- **全栈扩展**: 前后端统一的扩展架构

## 架构概览

### 整体架构
```
┌─────────────────────────────────────────────────────────────┐
│                     前端扩展框架                             │
├─────────────────────────────────────────────────────────────┤
│  Extension Framework │ Slot Manager │ Integration API       │
├─────────────────────────────────────────────────────────────┤
│  Extension Discovery │ Extension Loader │ Theme Manager     │
├─────────────────────────────────────────────────────────────┤
│                   VoxNest Core Framework                     │
├─────────────────────────────────────────────────────────────┤
│  Plugin Manager  │  Event Bus  │  Service Registry  │  API  │
├─────────────────────────────────────────────────────────────┤
│                    Plugin Runtime                           │
├─────────────────────────────────────────────────────────────┤
│  Plugin A  │  Plugin B  │  Plugin C  │  Plugin D  │  ...   │
└─────────────────────────────────────────────────────────────┘
```

### 前端扩展架构
```
┌─────────────────────────────────────────────────────────────┐
│                    React 应用层                              │
├─────────────────────────────────────────────────────────────┤
│  Slot Renderer │ Component Registry │ Route Manager        │
├─────────────────────────────────────────────────────────────┤
│              Extension Framework Core                       │
├─────────────────────────────────────────────────────────────┤
│  Integration Manager │ Lifecycle Hooks │ Context Provider   │
├─────────────────────────────────────────────────────────────┤
│               内置集成 (Built-in Integrations)               │
├─────────────────────────────────────────────────────────────┤
│  React │ DevTools │ Layout │ Style │ Router │ ...          │
├─────────────────────────────────────────────────────────────┤
│                   扩展发现与加载                             │
├─────────────────────────────────────────────────────────────┤
│  Extension Discovery │ Extension Loader │ Dynamic Import    │
└─────────────────────────────────────────────────────────────┘
```

## 前端扩展框架详细设计

### 核心概念

#### 1. 扩展框架 (Extension Framework)
扩展框架是前端插件系统的核心，负责管理扩展的生命周期、集成注册和组件槽位。

```typescript
interface ExtensionFramework {
  status: 'initializing' | 'ready' | 'error';
  config: VoxNestConfig;
  slots: SlotManager;
  integrations: IntegrationManager;
  logger: Logger;

  initialize(config?: VoxNestConfig): Promise<void>;
  register(integration: Integration): void;
  destroy(): Promise<void>;
  getStats(): any;
}
```

#### 2. 集成系统 (Integration API)
集成是可插拔的功能模块，通过钩子机制扩展框架功能。支持以下生命周期钩子：

- **framework:ready**: 框架初始化完成
- **components:ready**: 组件系统就绪  
- **app:start**: 应用启动前
- **app:started**: 应用启动后
- **app:destroy**: 应用销毁

```typescript
interface Integration {
  name: string;
  hooks?: {
    'framework:ready'?: (context: IntegrationContext) => void | Promise<void>;
    'components:ready'?: (context: IntegrationContext) => void | Promise<void>;
    'app:start'?: (context: IntegrationContext) => void | Promise<void>;
    'app:started'?: (context: IntegrationContext) => void | Promise<void>;
    'app:destroy'?: (context: IntegrationContext) => void | Promise<void>;
  };
}
```

#### 3. 槽位管理 (Slot Manager)
槽位系统允许在预定义的位置动态注册和渲染组件。

```typescript
interface SlotManager {
  register(slotId: string, registration: ComponentRegistration): void;
  unregister(slotId: string, source: string): void;
  unregisterBySource(source: string): void;
  getComponents(slotId: string): ComponentRegistration[];
  render(slotId: string, props?: any): React.ReactNode;
}
```

### 内置集成详解

#### 1. React 集成 (React Integration)
提供 React 特定的扩展支持，包括错误边界、悬念回退、开发工具等。

标准槽位：
- `react:error-boundary`: React 错误边界
- `react:suspense-fallback`: 悬念回退组件
- `react:dev-tools`: React 开发工具

#### 2. 布局集成 (Layout Integration)
定义标准的布局槽位体系，支持灵活的页面布局扩展。

标准槽位：
- `layout:header`: 页面头部
- `layout:header.left/center/right`: 头部区域细分
- `layout:sidebar`: 侧边栏
- `layout:sidebar.top/bottom`: 侧边栏区域细分
- `layout:content`: 主内容区
- `layout:content.before/after`: 内容区域扩展
- `layout:footer`: 页面底部
- `layout:footer.left/center/right`: 底部区域细分

#### 3. 样式集成 (Style Integration)
管理主题变量和动态样式注入。

CSS 变量：
```css
:root {
  --voxnest-primary: #1890ff;
  --voxnest-success: #52c41a;
  --voxnest-warning: #faad14;
  --voxnest-error: #f5222d;
  --voxnest-bg: #ffffff;
  --voxnest-text: #333333;
  --voxnest-border: #d9d9d9;
  --voxnest-radius: 6px;
  --voxnest-shadow: 0 2px 8px rgba(0,0,0,0.15);
}
```

#### 4. 开发工具集成 (DevTools Integration)
仅在开发模式下启用，提供调试和性能监控工具。

快捷键：
- `Ctrl+Shift+D`: 打开调试面板
- `Ctrl+Shift+S`: 查看框架状态

#### 5. 路由集成 (Router Integration)
支持路由变化监听和相关钩子。

标准槽位：
- `router:before-route-change`: 路由变化前
- `router:after-route-change`: 路由变化后
- `router:route-error`: 路由错误处理

### 扩展发现与加载

#### 扩展发现 (Extension Discovery)
自动发现 `/public/extensions` 目录中的插件和主题：

```
/public/extensions/
├── plugins/
│   └── example-plugin/
│       ├── manifest.json
│       ├── index.js
│       ├── plugin.js
│       └── styles.css
└── themes/
    └── dark-theme/
        ├── manifest.json
        └── theme.css
```

扩展清单格式：
```json
{
  "id": "example-plugin",
  "name": "示例插件",
  "version": "1.0.0",
  "type": "plugin|theme",
  "entry": "index.js",
  "styles": ["styles.css"],
  "scripts": ["plugin.js"],
  "config": {},
  "enabled": true
}
```

#### 扩展加载 (Extension Loader)
支持动态加载扩展资源：

1. **样式加载**: 动态创建 `<link>` 标签加载 CSS
2. **脚本加载**: 动态创建 `<script>` 标签加载 JS
3. **模块加载**: 使用动态 `import()` 加载 ES 模块
4. **实例注册**: 自动注册插件实例到框架

加载流程：
```
发现扩展 → 验证清单 → 加载资源 → 创建实例 → 注册到框架 → 执行初始化
```

## 插件生命周期

### 生命周期阶段
1. **Discovery**: 插件发现和扫描
2. **Loading**: 插件加载和初始化
3. **Activation**: 插件激活和注册
4. **Running**: 插件运行时管理
5. **Deactivation**: 插件停用和清理
6. **Unloading**: 插件卸载和资源释放

### 状态转换图
```
[Discovered] → [Loaded] → [Activated] → [Running]
     ↓             ↓           ↓           ↓
[Error]      [Error]    [Deactivated] → [Unloaded]
```

## 插件接口定义

### 核心接口

#### IPlugin 基础接口
```csharp
public interface IPlugin
{
    string Id { get; }
    string Name { get; }
    string Version { get; }
    string Description { get; }
    string Author { get; }
    
    Task<bool> InitializeAsync(IPluginContext context);
    Task<bool> StartAsync();
    Task<bool> StopAsync();
    Task<bool> UnloadAsync();
}
```

#### IPluginContext 上下文接口
```csharp
public interface IPluginContext
{
    IServiceProvider Services { get; }
    IConfiguration Configuration { get; }
    ILogger Logger { get; }
    IEventBus EventBus { get; }
    
    T GetService<T>() where T : class;
    void RegisterService<T>(T service) where T : class;
    void PublishEvent<T>(T eventData) where T : class;
    void SubscribeEvent<T>(Action<T> handler) where T : class;
}
```

### 扩展接口

#### IContentPlugin 内容插件接口
```csharp
public interface IContentPlugin : IPlugin
{
    string ContentType { get; }
    Task<ContentResult> CreateContentAsync(CreateContentRequest request);
    Task<ContentResult> UpdateContentAsync(UpdateContentRequest request);
    Task<ContentResult> DeleteContentAsync(DeleteContentRequest request);
    Task<ContentListResult> GetContentListAsync(GetContentListRequest request);
}
```

#### IUIPlugin 界面插件接口
```csharp
public interface IUIPlugin : IPlugin
{
    IEnumerable<RouteInfo> GetRoutes();
    IEnumerable<MenuInfo> GetMenuItems();
    IEnumerable<ComponentInfo> GetComponents();
    string GetClientScript();
    string GetClientStyles();
}
```

## 插件管理器

### 核心功能
```csharp
public interface IPluginManager
{
    // 插件发现和加载
    Task<IEnumerable<PluginInfo>> DiscoverPluginsAsync();
    Task<bool> LoadPluginAsync(string pluginId);
    Task<bool> UnloadPluginAsync(string pluginId);
    
    // 插件状态管理
    Task<bool> ActivatePluginAsync(string pluginId);
    Task<bool> DeactivatePluginAsync(string pluginId);
    PluginStatus GetPluginStatus(string pluginId);
    
    // 插件查询
    IEnumerable<IPlugin> GetActivePlugins();
    T GetPlugin<T>(string pluginId) where T : class, IPlugin;
    IEnumerable<T> GetPlugins<T>() where T : class, IPlugin;
}
```

### 插件发现机制
1. **文件系统扫描**: 扫描指定目录下的插件文件
2. **程序集反射**: 通过反射查找实现插件接口的类
3. **配置文件**: 通过配置文件指定插件列表
4. **在线商店（插件实现）**: 从插件商店下载和安装插件

## 事件总线系统

### 事件类型
```csharp
// 系统事件
public class SystemStartedEvent { }
public class SystemStoppingEvent { }

// 用户事件
public class UserRegisteredEvent 
{
    public int UserId { get; set; }
    public string Username { get; set; }
    public DateTime RegisterTime { get; set; }
}

// 内容事件
public class ContentCreatedEvent
{
    public int ContentId { get; set; }
    public string ContentType { get; set; }
    public int AuthorId { get; set; }
    public DateTime CreateTime { get; set; }
}
```

### 事件总线接口
```csharp
public interface IEventBus
{
    // 发布事件
    Task PublishAsync<T>(T eventData) where T : class;
    void Publish<T>(T eventData) where T : class;
    
    // 订阅事件
    void Subscribe<T>(Func<T, Task> handler) where T : class;
    void Subscribe<T>(Action<T> handler) where T : class;
    
    // 取消订阅
    void Unsubscribe<T>(Func<T, Task> handler) where T : class;
    void Unsubscribe<T>(Action<T> handler) where T : class;
}
```

## 前端插件系统实现

### 扩展框架初始化
```typescript
// 创建和初始化扩展框架
const framework = createExtensionFramework({
  appName: 'VoxNest',
  logLevel: 'debug',
  autoRegisterBuiltins: true,
});

// 注册自定义集成
framework.register(createCustomIntegration('my-plugin', {
  'components:ready': (context) => {
    context.slots.register('layout:header.right', {
      component: MyHeaderComponent,
      source: 'my-plugin',
      priority: 10,
    });
  }
}));

// 初始化框架
await framework.initialize();
```

### 扩展类型定义
```typescript
// 扩展清单类型
interface ExtensionManifest {
  id: string;
  name: string;
  version: string;
  author: string;
  description?: string;
  type: 'plugin' | 'theme';
  entry?: string;
  styles?: string[];
  scripts?: string[];
  dependencies?: string[];
  config?: Record<string, any>;
  enabled?: boolean;
}

// 组件注册类型
interface ComponentRegistration {
  component: React.ComponentType<any>;
  source: string;
  priority?: number;
  condition?: (props?: any) => boolean;
  props?: Record<string, any>;
  name?: string;
  description?: string;
}
```

### 槽位使用示例
```tsx
import { Slot } from '@voxnest/extension-framework';

// 在布局中使用槽位
export const Layout: React.FC = ({ children }) => {
  return (
    <div className="app-layout">
      <header className="header">
        <div className="header-left">
          <Slot id="layout:header.left" />
        </div>
        <div className="header-center">
          <Slot id="layout:header.center" />
        </div>
        <div className="header-right">
          <Slot id="layout:header.right" />
        </div>
      </header>
      
      <main className="main">
        <aside className="sidebar">
          <Slot id="layout:sidebar.top" />
          <Slot id="layout:sidebar" />
          <Slot id="layout:sidebar.bottom" />
        </aside>
        
        <div className="content">
          <Slot id="layout:content.before" />
          {children}
          <Slot id="layout:content.after" />
        </div>
      </main>
      
      <footer className="footer">
        <Slot id="layout:footer" />
      </footer>
    </div>
  );
};
```

### 扩展开发示例
```typescript
// 创建简单集成
const myIntegration = createSimpleIntegration(
  'my-feature',
  (context) => {
    context.logger.info('My feature initialized!');
    // 初始化逻辑
  }
);

// 创建组件集成
const myComponentIntegration = createComponentIntegration(
  'my-components',
  [
    {
      slotId: 'layout:header.right',
      component: MyHeaderWidget,
      priority: 5,
    },
    {
      slotId: 'layout:sidebar.top',
      component: MyNavigation,
      priority: 10,
    }
  ]
);

// 注册集成
framework.register(myIntegration);
framework.register(myComponentIntegration);
```

## 插件安全机制

### 权限控制
```csharp
public class PluginPermission
{
    public string PluginId { get; set; }
    public string Permission { get; set; }
    public bool IsGranted { get; set; }
}

public interface IPluginSecurity
{
    bool HasPermission(string pluginId, string permission);
    void GrantPermission(string pluginId, string permission);
    void RevokePermission(string pluginId, string permission);
    IEnumerable<string> GetRequiredPermissions(string pluginId);
}
```

### 沙箱隔离
- **程序集隔离**: 每个插件运行在独立的程序集上下文中
- **资源限制**: 限制插件的CPU、内存、网络使用
- **API访问控制**: 只允许访问授权的API和服务
- **文件系统隔离**: 限制插件的文件访问范围

## 插件配置管理

### 配置结构
```json
{
  "plugins": {
    "blog-plugin": {
      "enabled": true,
      "version": "1.0.0",
      "settings": {
        "maxPostLength": 10000,
        "allowComments": true,
        "moderationEnabled": false
      }
    },
    "forum-plugin": {
      "enabled": true,
      "version": "2.1.0",
      "settings": {
        "maxTopicsPerPage": 20,
        "allowAnonymousPosts": false
      }
    }
  }
}
```

### 配置接口
```csharp
public interface IPluginConfiguration
{
    T GetSetting<T>(string pluginId, string key, T defaultValue = default);
    void SetSetting<T>(string pluginId, string key, T value);
    void SaveSettings(string pluginId);
    void LoadSettings(string pluginId);
}
```

## 插件开发工具包

### 项目模板
```bash
# 创建新插件项目
dotnet new voxnest-plugin -n MyPlugin

# 项目结构
MyPlugin/
├── MyPlugin.csproj
├── Plugin.cs
├── Controllers/
├── Services/
├── Models/
├── Views/
└── plugin.json
```

### 开发工具
- **插件模板**: 插件模板仓库骨架
- **打包工具**: 插件打包和发布工具

## 性能优化

### 延迟加载
- 按需加载插件模块
- 异步初始化非关键插件
- 缓存插件元数据

### 资源管理
- 插件资源池化
- 内存使用监控
- 垃圾回收优化

### 并发控制
- 插件操作线程安全
- 异步事件处理
- 资源竞争避免