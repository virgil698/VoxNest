# VoxNest 插件系统架构设计

## 设计目标

### 核心目标
- **模块化**: 功能完全解耦，独立开发和部署
- **热插拔**: 运行时动态加载和卸载插件
- **标准化**: 统一的插件开发接口和规范
- **性能**: 最小化插件对系统性能的影响

## 架构概览

```
┌─────────────────────────────────────────────────────────────┐
│                    VoxNest Core Framework                    │
├─────────────────────────────────────────────────────────────┤
│  Plugin Manager  │  Event Bus  │  Service Registry  │  API  │
├─────────────────────────────────────────────────────────────┤
│                    Plugin Runtime                           │
├─────────────────────────────────────────────────────────────┤
│  Plugin A  │  Plugin B  │  Plugin C  │  Plugin D  │  ...   │
└─────────────────────────────────────────────────────────────┘
```

## 插件生命周期

### 生命周期阶段
1. **Discovery**: 插件发现和扫描
2. **Loading**: 插件加载和初始化
3. **Activation**: 插件激活和注册
4. **Running**: 插件运行时管理
5. **Deactivation**: 插件停用和清理
6. **Unloading**: 插件卸载和资源释放

### 状态转换图
```
[Discovered] → [Loaded] → [Activated] → [Running]
     ↓             ↓           ↓           ↓
[Error]      [Error]    [Deactivated] → [Unloaded]
```

## 插件接口定义

### 核心接口

#### IPlugin 基础接口
```csharp
public interface IPlugin
{
    string Id { get; }
    string Name { get; }
    string Version { get; }
    string Description { get; }
    string Author { get; }
    
    Task<bool> InitializeAsync(IPluginContext context);
    Task<bool> StartAsync();
    Task<bool> StopAsync();
    Task<bool> UnloadAsync();
}
```

#### IPluginContext 上下文接口
```csharp
public interface IPluginContext
{
    IServiceProvider Services { get; }
    IConfiguration Configuration { get; }
    ILogger Logger { get; }
    IEventBus EventBus { get; }
    
    T GetService<T>() where T : class;
    void RegisterService<T>(T service) where T : class;
    void PublishEvent<T>(T eventData) where T : class;
    void SubscribeEvent<T>(Action<T> handler) where T : class;
}
```

### 扩展接口

#### IContentPlugin 内容插件接口
```csharp
public interface IContentPlugin : IPlugin
{
    string ContentType { get; }
    Task<ContentResult> CreateContentAsync(CreateContentRequest request);
    Task<ContentResult> UpdateContentAsync(UpdateContentRequest request);
    Task<ContentResult> DeleteContentAsync(DeleteContentRequest request);
    Task<ContentListResult> GetContentListAsync(GetContentListRequest request);
}
```

#### IUIPlugin 界面插件接口
```csharp
public interface IUIPlugin : IPlugin
{
    IEnumerable<RouteInfo> GetRoutes();
    IEnumerable<MenuInfo> GetMenuItems();
    IEnumerable<ComponentInfo> GetComponents();
    string GetClientScript();
    string GetClientStyles();
}
```

## 插件管理器

### 核心功能
```csharp
public interface IPluginManager
{
    // 插件发现和加载
    Task<IEnumerable<PluginInfo>> DiscoverPluginsAsync();
    Task<bool> LoadPluginAsync(string pluginId);
    Task<bool> UnloadPluginAsync(string pluginId);
    
    // 插件状态管理
    Task<bool> ActivatePluginAsync(string pluginId);
    Task<bool> DeactivatePluginAsync(string pluginId);
    PluginStatus GetPluginStatus(string pluginId);
    
    // 插件查询
    IEnumerable<IPlugin> GetActivePlugins();
    T GetPlugin<T>(string pluginId) where T : class, IPlugin;
    IEnumerable<T> GetPlugins<T>() where T : class, IPlugin;
}
```

### 插件发现机制
1. **文件系统扫描**: 扫描指定目录下的插件文件
2. **程序集反射**: 通过反射查找实现插件接口的类
3. **配置文件**: 通过配置文件指定插件列表
4. **在线商店（插件实现）**: 从插件商店下载和安装插件

## 事件总线系统

### 事件类型
```csharp
// 系统事件
public class SystemStartedEvent { }
public class SystemStoppingEvent { }

// 用户事件
public class UserRegisteredEvent 
{
    public int UserId { get; set; }
    public string Username { get; set; }
    public DateTime RegisterTime { get; set; }
}

// 内容事件
public class ContentCreatedEvent
{
    public int ContentId { get; set; }
    public string ContentType { get; set; }
    public int AuthorId { get; set; }
    public DateTime CreateTime { get; set; }
}
```

### 事件总线接口
```csharp
public interface IEventBus
{
    // 发布事件
    Task PublishAsync<T>(T eventData) where T : class;
    void Publish<T>(T eventData) where T : class;
    
    // 订阅事件
    void Subscribe<T>(Func<T, Task> handler) where T : class;
    void Subscribe<T>(Action<T> handler) where T : class;
    
    // 取消订阅
    void Unsubscribe<T>(Func<T, Task> handler) where T : class;
    void Unsubscribe<T>(Action<T> handler) where T : class;
}
```

## 前端插件系统

### 动态模块加载
```typescript
interface PluginModule {
  id: string;
  name: string;
  version: string;
  routes?: RouteConfig[];
  components?: ComponentConfig[];
  services?: ServiceConfig[];
  initialize?: (context: PluginContext) => Promise<void>;
  destroy?: () => Promise<void>;
}

class PluginLoader {
  async loadPlugin(pluginUrl: string): Promise<PluginModule> {
    const module = await import(pluginUrl);
    return module.default;
  }
  
  async registerPlugin(plugin: PluginModule): Promise<void> {
    // 注册路由
    if (plugin.routes) {
      this.routeManager.addRoutes(plugin.routes);
    }
    
    // 注册组件
    if (plugin.components) {
      this.componentRegistry.register(plugin.components);
    }
    
    // 初始化插件
    if (plugin.initialize) {
      await plugin.initialize(this.createContext());
    }
  }
}
```

### 插件通信机制
```typescript
interface PluginContext {
  // 服务注册和获取
  registerService<T>(name: string, service: T): void;
  getService<T>(name: string): T | undefined;
  
  // 事件发布和订阅
  emit(event: string, data: any): void;
  on(event: string, handler: (data: any) => void): void;
  off(event: string, handler: (data: any) => void): void;
  
  // 路由操作
  navigate(path: string): void;
  getCurrentRoute(): RouteInfo;
  
  // 状态管理
  getState<T>(key: string): T | undefined;
  setState<T>(key: string, value: T): void;
}
```

## 插件安全机制

### 权限控制
```csharp
public class PluginPermission
{
    public string PluginId { get; set; }
    public string Permission { get; set; }
    public bool IsGranted { get; set; }
}

public interface IPluginSecurity
{
    bool HasPermission(string pluginId, string permission);
    void GrantPermission(string pluginId, string permission);
    void RevokePermission(string pluginId, string permission);
    IEnumerable<string> GetRequiredPermissions(string pluginId);
}
```

### 沙箱隔离
- **程序集隔离**: 每个插件运行在独立的程序集上下文中
- **资源限制**: 限制插件的CPU、内存、网络使用
- **API访问控制**: 只允许访问授权的API和服务
- **文件系统隔离**: 限制插件的文件访问范围

## 插件配置管理

### 配置结构
```json
{
  "plugins": {
    "blog-plugin": {
      "enabled": true,
      "version": "1.0.0",
      "settings": {
        "maxPostLength": 10000,
        "allowComments": true,
        "moderationEnabled": false
      }
    },
    "forum-plugin": {
      "enabled": true,
      "version": "2.1.0",
      "settings": {
        "maxTopicsPerPage": 20,
        "allowAnonymousPosts": false
      }
    }
  }
}
```

### 配置接口
```csharp
public interface IPluginConfiguration
{
    T GetSetting<T>(string pluginId, string key, T defaultValue = default);
    void SetSetting<T>(string pluginId, string key, T value);
    void SaveSettings(string pluginId);
    void LoadSettings(string pluginId);
}
```

## 插件开发工具包

### 项目模板
```bash
# 创建新插件项目
dotnet new voxnest-plugin -n MyPlugin

# 项目结构
MyPlugin/
├── MyPlugin.csproj
├── Plugin.cs
├── Controllers/
├── Services/
├── Models/
├── Views/
└── plugin.json
```

### 开发工具
- **插件模板**: 插件模板仓库骨架
- **打包工具**: 插件打包和发布工具

## 性能优化

### 延迟加载
- 按需加载插件模块
- 异步初始化非关键插件
- 缓存插件元数据

### 资源管理
- 插件资源池化
- 内存使用监控
- 垃圾回收优化

### 并发控制
- 插件操作线程安全
- 异步事件处理
- 资源竞争避免